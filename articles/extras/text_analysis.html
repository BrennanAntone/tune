<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Text Analysis Example • tune</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../../tidyverse.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><link href="../../tidyverse-2.css" rel="stylesheet">
<!--optional theme--><link href="../../tidymodels.css" rel="stylesheet">
<meta property="og:title" content="Text Analysis Example">
<meta property="og:description" content="tune">
<meta property="og:image" content="https://tune.tidymodels.org/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../../index.html">tune</a>
        <div class="info hidden-xs hidden-sm">
          <span class="partof">part of <a href="https://tidymodels.org">tidymodels</a></span>
          <span class="version version-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../../articles/getting_started.html">Getting Started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/grid.html">Grid Search</a>
    </li>
    <li>
      <a href="../../articles/acquisition_functions.html">Acquisition Functions</a>
    </li>
    <li>
      <a href="../../articles/extras/svm_classification.html">Bayesian Optimization of Classification Model</a>
    </li>
    <li>
      <a href="../../articles/extras/optimizations.html">Optimizations and Parallel Processing</a>
    </li>
    <li>
      <a href="../../articles/extras/text_analysis.html">Text Analysis Example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
        <li>
  <a href="https://github.com/tidymodels/tune/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="text_analysis_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Text Analysis Example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/tune/blob/master/vignettes/extras/text_analysis.Rmd"><code>vignettes/extras/text_analysis.Rmd</code></a></small>
      <div class="hidden name"><code>text_analysis.Rmd</code></div>

    </div>

    
    
<p>This advanced example shows how to process text data with recipes and use them in a predictive model. It also has an example of extracting information from each model fit for later use.</p>
<p>The data are from Amazon:</p>
<blockquote>
<p>“This dataset consists of reviews of fine foods from amazon. The data span a period of more than 10 years, including all ~500,000 reviews up to October 2012. Reviews include product and user information, ratings, and a plaintext review.”</p>
</blockquote>
<p>A small subset of the data are contained here; we sampled a single review from 5,000 random products and 80% of these data were used as the training set. The remaining 1,000 were used as the test set.</p>
<p>There is a column for the product, a column for the text of the review, and a factor column for a class variable. The outcome is whether the reviewer game the product a five-star rating or not.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"small_fine_foods"</span><span class="op">)</span>
<span class="va">training_data</span></pre></div>
<p>The idea is to process the text data into features and use these features to predict whether the review was five-star or not.</p>
<div id="recipe-and-model-specifications" class="section level2">
<h2 class="hasAnchor">
<a href="#recipe-and-model-specifications" class="anchor"></a>Recipe and Model Specifications</h2>
<p>The data processing steps are:</p>
<ul>
<li><p>create an initial set of features based on simple word/character scores, such as the number of words, URLs and so on; The <a href="https://github.com/mkearney/textfeatures"><code>textfeatures</code></a> will be used for this</p></li>
<li><p>the text is tokenized (i.e. broken into smaller components such as words)</p></li>
<li><p>stop words (such as “the”, “an”, etc.) are removed</p></li>
<li><p>tokens are stemmed to a common root where possible</p></li>
<li><p>tokens are converted to dummy variables via a <a href="https://bookdown.org/max/FES/encoding-predictors-with-many-categories.html">signed, binary hash function</a></p></li>
<li><p>non-token features are optionally transformed to a more symmetric state using a <a href="https://bookdown.org/max/FES/numeric-one-to-one.html">Yeo-Johnson transformation</a></p></li>
<li><p>predictors with a single distinct value are removed</p></li>
<li><p>all predictors are centered and scaled.</p></li>
</ul>
<p>Some of these steps may or may not be good ideas (such as stemming). In this process, the main tuning parameter will be the number of feature hash features to use.</p>
<p>A recipe will be used to implement this. We’ll also need some helper objects. For example, for the Yeo-Johnson transformation, we need to know the initial feature set:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mkearney/textfeatures">textfeatures</a></span><span class="op">)</span>

<span class="va">basics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="fu">textfeatures</span><span class="fu">:::</span><span class="va"><a href="https://rdrr.io/pkg/textfeatures/man/count_functions.html">count_functions</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">basics</span><span class="op">)</span></pre></div>
<p>Also, the implementation of feature hashes does not produce binary values. This small function will help convert the scores to values of -1, 0, or 1:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">binary_hash</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="op">-</span><span class="fl">1</span>, <span class="va">x</span><span class="op">)</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span>,  <span class="fl">1</span>, <span class="va">x</span><span class="op">)</span>
  <span class="va">x</span>
<span class="op">}</span></pre></div>
<p>The recipe is:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="co"># uses the devel version of textrecipes</span>
<span class="co"># devtools::install_github("tidymodels/textrecipes")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/textrecipes">textrecipes</a></span><span class="op">)</span>

<span class="va">pre_proc</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op">(</span><span class="va">score</span> <span class="op">~</span> <span class="va">product</span> <span class="op">+</span> <span class="va">review</span>, data <span class="op">=</span> <span class="va">training_data</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Do not use the product ID as a predictor</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html">update_role</a></span><span class="op">(</span><span class="va">product</span>, new_role <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Make a copy of the raw text</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate.html">step_mutate</a></span><span class="op">(</span>review_raw <span class="op">=</span> <span class="va">review</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Compute the initial features. This removes the `review_raw` column</span>
  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_textfeature.html">step_textfeature</a></span><span class="op">(</span><span class="va">review_raw</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Make the feature names shorter</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_rename_at.html">step_rename_at</a></span><span class="op">(</span>
    <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"textfeature_"</span><span class="op">)</span>,
    fn <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"textfeature_review_raw_"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">step_tokenize</a></span><span class="op">(</span><span class="va">review</span><span class="op">)</span>  <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_stopwords.html">step_stopwords</a></span><span class="op">(</span><span class="va">review</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_stem.html">step_stem</a></span><span class="op">(</span><span class="va">review</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Here is where the tuning parameter is declared</span>
  <span class="fu"><a href="https://textrecipes.tidymodels.org/reference/step_texthash.html">step_texthash</a></span><span class="op">(</span><span class="va">review</span>, signed <span class="op">=</span> <span class="cn">TRUE</span>, num_terms <span class="op">=</span> <span class="fu"><a href="../../reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Simplify these names</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_rename_at.html">step_rename_at</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"review_hash"</span><span class="op">)</span>, fn <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"review_"</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Convert the features from counts to values of -1, 0, or 1</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_mutate_at.html">step_mutate_at</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"hash"</span><span class="op">)</span>, fn <span class="op">=</span> <span class="va">binary_hash</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co"># Transform the initial feature set</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_YeoJohnson.html">step_YeoJohnson</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/one_of.html">one_of</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">basics</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_zv.html">step_zv</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_normalize.html">step_normalize</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>Note that, when objects from the global environment are used, they are injected into the step objects via <code>!!</code>. For some parallel processing technologies, these objects may not be found by the worker processes.</p>
<p>To model these data, a regularized logistic regression model will be used:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">lr_mod</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/logistic_reg.html">logistic_reg</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fu"><a href="../../reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>, mixture <span class="op">=</span> <span class="fu"><a href="../../reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span><span class="st">"glmnet"</span><span class="op">)</span></pre></div>
<p>Three tuning parameters should be trained for this data analysis.</p>
</div>
<div id="resampling" class="section level2">
<h2 class="hasAnchor">
<a href="#resampling" class="anchor"></a>Resampling</h2>
<p>There are enough data here such that 10-fold resampling would hold out 400 reviews at a time to estimate performance. Performance estimates using this many observations have sufficiently low noise to measure and tune models.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8935</span><span class="op">)</span>
<span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/vfold_cv.html">vfold_cv</a></span><span class="op">(</span><span class="va">training_data</span><span class="op">)</span></pre></div>
</div>
<div id="grid-search" class="section level2">
<h2 class="hasAnchor">
<a href="#grid-search" class="anchor"></a>Grid Search</h2>
<p>A regular grid is used. For <code>glmnet</code> models, evaluating penalty values is fairly cheap due to the use of the “submodel-trick”. The grid will use 20 penalty values, 5 mixture values, and 3 values for the number of hash features.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">five_star_grid</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span>
    penalty <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">0</span>, length <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
    mixture <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,
    num_terms <span class="op">=</span> <span class="fl">2</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">10</span>, <span class="fl">12</span><span class="op">)</span>
  <span class="op">)</span></pre></div>
<p>Note that, for each resample, the text processing recipe is only prepped 6 times. This increases the computational efficiency of the analysis by avoiding redundant work.</p>
<p>For illustration, we will save information on the number of predictors by penalty value for each <code>glmnet</code> model. This might help use understand how many features were used across the penalty values. An extraction function is used to do this:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="va">glmnet_vars</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># `x` will be a workflow object</span>
  <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extract_recipe.html">extract_model</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="co"># `df` is the number of model terms for each penalty value</span>
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">lambda</span>, num_vars <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">df</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/control_grid.html">control_grid</a></span><span class="op">(</span>extract <span class="op">=</span> <span class="va">glmnet_vars</span><span class="op">)</span></pre></div>
<p>Finally, let’s run the grid search:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">roc_scores</span> <span class="op">&lt;-</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">roc_auc</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1559</span><span class="op">)</span>
<span class="va">five_star_glmnet</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../../reference/tune_grid.html">tune_grid</a></span><span class="op">(</span><span class="va">lr_mod</span>, <span class="va">pre_proc</span>, resamples <span class="op">=</span> <span class="va">folds</span>, grid <span class="op">=</span> <span class="va">five_star_grid</span>, 
            metrics <span class="op">=</span> <span class="va">roc_scores</span>, control <span class="op">=</span> <span class="va">ctrl</span><span class="op">)</span></pre></div>
<p>This took a while to complete. What did the results look like? Let’s get the resampling estimates of the area under the ROC curve for each tuning parameter:</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">grid_roc</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../../reference/collect_predictions.html">collect_metrics</a></span><span class="op">(</span><span class="va">five_star_glmnet</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span>
<span class="va">grid_roc</span></pre></div>
<p>The best results had a fairly high penalty value and focused on the ridge penalty (i.e. no feature selection via the lasso’s L1 penalty). The best solutions also used the largest number of hashing features.</p>
<p>What was the relationship between performance and the tuning parameters?</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">five_star_glmnet</span>, metric <span class="op">=</span> <span class="st">"roc_auc"</span><span class="op">)</span></pre></div>
<p>There is definitely an effect due to the number of features used<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. The profiles with mixture values greater than zero had steep drop-offs in performance. What’s that about? Those are cases where the lasso penalty is removing too many (and perhaps all) features from the model<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p>
<p>It’s clear from the panels at least 4096 features that there are several parameter combinations that have roughly equivalent performance. A case could be made to choose a larger mixture value and less of a penalty to select a more simplistic model that contains fewer predictors. If more experimentation were conducted, a largest set of features should also be considered.</p>
<p>We’ll come back to the extracted <code>glmnet</code> components at the end of this example.</p>
</div>
<div id="directed-search" class="section level2">
<h2 class="hasAnchor">
<a href="#directed-search" class="anchor"></a>Directed Search</h2>
<p>What if we had started with Bayesian optimization? Would a good set of conditions have been found more efficiently?</p>
<p>Let’s pretend that we haven’t seen the grid search results. We’ll initialize the Gaussian process model with five tuning parameter combinations chosen with a space-filling design.</p>
<p>It might be good to use a custom <code>dials</code> object for the number of hash terms. The default object, <code><a href="https://dials.tidymodels.org/reference/num_comp.html">num_terms()</a></code>, uses a linear range and tries to set the upper bound of the parameter using the data. Instead, let’s create a parameter set, change the scale to be log2, and define the same range as was used in grid search.</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="va">hash_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dials.tidymodels.org/reference/num_comp.html">num_terms</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">12</span><span class="op">)</span>, trans <span class="op">=</span> <span class="fu">log2_trans</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>To use this, we have to merge the recipe and <code>parsnip</code> model object into a workflow:</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/workflows">workflows</a></span><span class="op">)</span>
<span class="va">five_star_wflow</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://workflows.tidymodels.org//reference/workflow.html">workflow</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://workflows.tidymodels.org//reference/add_recipe.html">add_recipe</a></span><span class="op">(</span><span class="va">pre_proc</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://workflows.tidymodels.org//reference/add_model.html">add_model</a></span><span class="op">(</span><span class="va">lr_mod</span><span class="op">)</span></pre></div>
<p>Then we can extract and manipulate the corresponding parameter set:</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="va">five_star_set</span> <span class="op">&lt;-</span>
  <span class="va">five_star_wflow</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dials.tidymodels.org/reference/parameters.html">parameters</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span>
    num_terms <span class="op">=</span> <span class="va">hash_range</span>, 
    penalty <span class="op">=</span> <span class="fu"><a href="https://dials.tidymodels.org/reference/penalty.html">penalty</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>,
    mixture <span class="op">=</span> <span class="fu"><a href="https://dials.tidymodels.org/reference/mixture.html">mixture</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">1.00</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span></pre></div>
<p>This is passed to the search function via the <code>param_info</code> argument.</p>
<p>Finally, the initial rounds of search can be biased more towards exploration of the parameter space (as opposed to staying near the current best results). If expected improvement is used as the acquisition function, the trade-off value can be slowly moved from exploration to exploitation over iterations<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>. <code>tune</code> has a built-in function called <code><a href="../../reference/expo_decay.html">expo_decay()</a></code> that can help accomplish this:</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="va">trade_off_decay</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">iter</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../../reference/expo_decay.html">expo_decay</a></span><span class="op">(</span><span class="va">iter</span>, start_val <span class="op">=</span> <span class="fl">.01</span>, limit_val <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p>Using these values, let’s run the search:</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span>
<span class="va">five_star_search</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../../reference/tune_bayes.html">tune_bayes</a></span><span class="op">(</span>
    <span class="va">five_star_wflow</span>, 
    resamples <span class="op">=</span> <span class="va">folds</span>,
    param_info <span class="op">=</span> <span class="va">five_star_set</span>,
    initial <span class="op">=</span> <span class="fl">5</span>,
    iter <span class="op">=</span> <span class="fl">30</span>,
    metrics <span class="op">=</span> <span class="va">roc_scores</span>,
    objective <span class="op">=</span> <span class="fu"><a href="../../reference/prob_improve.html">exp_improve</a></span><span class="op">(</span><span class="va">trade_off_decay</span><span class="op">)</span>,
    control <span class="op">=</span> <span class="fu"><a href="../../reference/control_bayes.html">control_bayes</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">)</span></pre></div>
<p>The results show some improvement over the initial set. One issue is that so many settings are sub-optimal (as shown in the figure above for grid search) so there are poor results periodically. There are regions where the penalty parameter becomes too large and all of the predictors are removed from the model. These regions are also dependent on the number of terms. There is a fairly narrow ridge<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a> where good performance can be achieved. Using more iterations would probably result in the search finding better results.</p>
<p>A plot of model performance versus the search iterations:</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">five_star_search</span>, type <span class="op">=</span> <span class="st">"performance"</span><span class="op">)</span></pre></div>
<p>What would we do if we knew about the grid search results? In this case, we would restrict the range for the number of hash features to be larger (especially with more data). We might also restrict the penalty and mixture parameters to have a more restricted upper bound.</p>
</div>
<div id="extracted-results" class="section level2">
<h2 class="hasAnchor">
<a href="#extracted-results" class="anchor"></a>Extracted Results</h2>
<p>Jumping back to the grid search results, let’s examine the results of our <code>extract</code> function. For each <em>fitted model</em>, a tibble was saved that has the relationship between the number of predictors and the penalty value. Let’s look at these results for the best model:</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/show_best.html">select_best</a></span><span class="op">(</span><span class="va">five_star_glmnet</span>, metric <span class="op">=</span> <span class="st">"roc_auc"</span><span class="op">)</span>
<span class="va">params</span></pre></div>
<p>Recall that we saved the <code>glmnet</code> results in a tibble. The column <code>five_star_glmnet$.extracts</code> is a list of tibbles. As an example, the first element of the list is:</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="va">five_star_glmnet</span><span class="op">$</span><span class="va">.extracts</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></pre></div>
<p>More nested tibbles! Let’s unnest <code>five_star_glmnet$.extracts</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="va">extracted</span> <span class="op">&lt;-</span> 
  <span class="va">five_star_glmnet</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">.extracts</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">.extracts</span><span class="op">)</span>
<span class="va">extracted</span></pre></div>
<p>One thing to realize here is that <code><a href="../../reference/tune_grid.html">tune_grid()</a></code> <a href="optimizations.html">may not fit all of the models</a> that are evaluated. In this case, for each value of <code>mixture</code> and <code>num_terms</code>, the model is fit overall <em>all</em> penalty values<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a>. To select the best parameter set, we can exclude the <code>penalty</code> column in <code>extracted</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="va">extracted</span> <span class="op">&lt;-</span> 
  <span class="va">extracted</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">penalty</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">params</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"num_terms"</span>, <span class="st">"mixture"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co"># Now remove it from the final results</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">penalty</span><span class="op">)</span>
<span class="va">extracted</span></pre></div>
<p>Now we can get at the results that we want using another <code>unnest</code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="va">extracted</span> <span class="op">&lt;-</span> 
  <span class="va">extracted</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>col <span class="op">=</span> <span class="va">.extracts</span><span class="op">)</span> <span class="co"># &lt;- these contain a `penalty` column</span>
<span class="va">extracted</span></pre></div>
<p>Let’s look at a plot of these results (per resample):</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">extracted</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">penalty</span>, y <span class="op">=</span> <span class="va">num_vars</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">id</span>, col <span class="op">=</span> <span class="va">id</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Number of retained predictors"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span>  <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"mixture = "</span>, <span class="va">params</span><span class="op">$</span><span class="va">mixture</span>, <span class="st">"and"</span>, <span class="va">params</span><span class="op">$</span><span class="va">num_terms</span>, <span class="st">"features"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></pre></div>
<p>These results might help guide the range of the <code>penalty</code> value if more optimization was conducted.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>This is a small sample of the overall data set. When more data are used, a larger feature set is optimal.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>See the last section below for more details.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>See the vignette on <a href="../acquisition_functions.html">acquisition functions</a> for more details.<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>Sorry, pun intended.<a href="#fnref4" class="footnote-back">↩︎</a></p></li>
<li id="fn5"><p>This is a feature of this particular model and is not generally true for other engines.<a href="#fnref5" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="tidyverse">
  <p>tune is a part of the <strong>tidymodels</strong> ecosystem, a collection of modeling packages designed with common APIs and a shared philosophy.</p>
</div>

<div class="author">
  <p>
    Developed by Max Kuhn.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  


  </body>
</html>
